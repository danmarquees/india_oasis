{% extends 'admin/base_site.html' %}
{% block content %}
<link rel="stylesheet" href="/static/css/custom.css">
<div class="admin-panel">
    <div id="notificacoes-bell" class="admin-notification-bell">
        <i class="fas fa-bell"></i>
        <span id="notificacoes-badge" class="admin-notification-badge" style="display:none;">0</span>
    </div>
    <div id="notificacoes-dropdown" class="admin-notification-dropdown"></div>

    <h1 style="margin-bottom:0.2em;">Painel de Pagamentos</h1>
    <p style="margin-bottom:2em;">Bem-vindo ao painel de pagamentos do India Oasis.</p>

    {% if alertas %}
        <div style="display: flex; flex-direction: column; gap: 1em; margin-bottom: 2em;">
            {% for alerta in alertas %}
                <div class="admin-card" style="background: #fffbe6; border-left: 6px solid #f59e0b; color: #b45309; font-weight: 500; box-shadow: 0 1px 4px #0001;">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5em;"></i> {{ alerta }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Filtro de status -->
    <div class="admin-card" style="display: flex; align-items: center; gap: 1em; flex-wrap: wrap; margin-bottom: 2em;">
        <form method="get" style="display: flex; align-items: center; gap: 0.5em;">
            <label for="status_filtro"><strong>Filtrar por status:</strong></label>
            <select name="status" id="status_filtro" onchange="this.form.submit()" style="padding: 0.3em 0.7em; border-radius: 4px; border: 1px solid #ccc;">
                <option value="">Todos</option>
                {% for status in status_unicos %}
                    <option value="{{ status }}" {% if status == status_filtro %}selected{% endif %}>{{ status|title }}</option>
                {% endfor %}
            </select>
        </form>
        {% if status_filtro %}
            <a href="?" style="margin-left: 1em; color: #3b82f6; text-decoration: underline;">Limpar filtro</a>
        {% endif %}
        <button id="btn-reprocessar-todos" class="admin-btn" style="margin-left:auto;" onclick="reprocessarTodos()">
            <i class="fas fa-sync-alt"></i> Reprocessar todos os pendentes
        </button>
    </div>

    <div style="display: flex; flex-wrap: wrap; gap: 2em; margin-bottom: 2em;">
        <!-- Card do Gráfico -->
        <div class="admin-card" style="min-width: 260px; max-width: 340px; flex: 1 1 320px; display: flex; flex-direction: column; align-items: center;">
            <h2 style="font-size: 1.1em; margin-bottom: 1em;">Resumo dos Pagamentos</h2>
            <canvas id="statusChart" width="220" height="220"></canvas>
        </div>
        <!-- Card da Tabela -->
        <div class="admin-card" style="min-width: 320px; max-width: 600px; flex: 2 1 400px;">
            <h2 style="font-size: 1.1em; margin-bottom: 1em;">Últimos 10 Pagamentos</h2>
            <div style="overflow-x:auto;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuário</th>
                            <th>Valor Total</th>
                            <th>Status</th>
                            <th>Pago?</th>
                            <th>Data</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in ultimos_pedidos %}
                        <tr>
                            <td data-label="ID">{{ pedido.id }}</td>
                            <td data-label="Usuário">{{ pedido.user }}</td>
                            <td data-label="Valor Total">R$ {{ pedido.total_price }}</td>
                            <td data-label="Status">
                                <span class="admin-status {% if pedido.status == 'paid' %}paid{% elif pedido.status == 'pending' or pedido.status == 'aguardando_pagamento' %}pending{% elif pedido.status == 'cancelled' %}cancelled{% endif %}">
                                    {% if pedido.status == 'paid' %}<i class="fas fa-check-circle"></i>{% elif pedido.status == 'pending' or pedido.status == 'aguardando_pagamento' %}<i class="fas fa-clock"></i>{% elif pedido.status == 'cancelled' %}<i class="fas fa-times-circle"></i>{% else %}<i class="fas fa-info-circle"></i>{% endif %}
                                    {{ pedido.status|title }}
                                </span>
                            </td>
                            <td data-label="Pago?">{% if pedido.paid %}<span class="admin-status paid"><i class="fas fa-check"></i>Sim</span>{% else %}<span class="admin-status pending"><i class="fas fa-times"></i>Não</span>{% endif %}</td>
                            <td data-label="Data">{{ pedido.created|date:"d/m/Y H:i" }}</td>
                            <td data-label="Ações">
                                {% if pedido.status == 'pending' or pedido.status == 'aguardando_pagamento' %}
                                    <button onclick="reprocessarPedido({{ pedido.id }})" class="admin-btn secondary" style="margin-right:0.3em;">
                                        <i class="fas fa-sync-alt"></i> Reprocessar
                                    </button>
                                    <button onclick="cancelarPedido({{ pedido.id }})" class="admin-btn danger">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                {% else %}
                                    <span style="color:#888;">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="7">Nenhum pagamento encontrado.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('statusChart').getContext('2d');
    const statusChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: {{ status_labels|safe }},
            datasets: [{
                label: 'Pagamentos por Status',
                data: {{ status_data|safe }},
                backgroundColor: [
                    '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#a78bfa', '#f472b6', '#f87171'
                ],
            }]
        },
        options: {
            responsive: false,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                title: {
                    display: false
                }
            }
        }
    });

    function reprocessarPedido(id) {
        if (!confirm('Deseja reprocessar o pedido #' + id + '?')) return;
        fetch('{% url 'payment_processing:reprocessar_pedido' 0 %}'.replace('/0/', '/' + id + '/'), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(r => r.json())
        .then(data => { alert(data.msg); location.reload(); });
    }
    function cancelarPedido(id) {
        if (!confirm('Deseja cancelar o pedido #' + id + '?')) return;
        fetch('{% url 'payment_processing:cancelar_pedido' 0 %}'.replace('/0/', '/' + id + '/'), {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(r => r.json())
        .then(data => { alert(data.msg); location.reload(); });
    }
    function reprocessarTodos() {
        if (!confirm('Deseja reprocessar TODOS os pedidos pendentes?')) return;
        fetch('{% url 'payment_processing:reprocessar_todos_pendentes' %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(r => r.json())
        .then(data => { alert(data.msg); location.reload(); });
    }

    // Sininho de notificações
    const bell = document.getElementById('notificacoes-bell');
    const badge = document.getElementById('notificacoes-badge');
    const dropdown = document.getElementById('notificacoes-dropdown');
    let dropdownOpen = false;
    function renderNotificacoes(notificacoes, naoLidas) {
        badge.style.display = naoLidas > 0 ? 'block' : 'none';
        badge.textContent = naoLidas;
        let html = '';
        if (notificacoes.length === 0) {
            html = '<div class="admin-notification-item">Nenhuma notificação recente.</div>';
        } else {
            notificacoes.forEach(n => {
                html += `<div class="admin-notification-item${n.is_read ? '' : ' unread'}">` +
                    `<span class="icon"><i class="fas fa-bell"></i></span>` +
                    `<span>${n.message}</span>` +
                    `<span style="margin-left:auto; color:#888; font-size:0.9em;">${n.created_at}</span>` +
                    `</div>`;
            });
        }
        dropdown.innerHTML = html;
    }
    function fetchNotificacoes() {
        fetch('{% url 'payment_processing:notificacoes_recentes' %}')
            .then(r => r.json())
            .then(data => renderNotificacoes(data.notificacoes, data.nao_lidas));
    }
    bell.addEventListener('click', () => {
        dropdownOpen = !dropdownOpen;
        dropdown.classList.toggle('active', dropdownOpen);
        if (dropdownOpen) fetchNotificacoes();
    });
    // Atualiza badge a cada 20s
    setInterval(fetchNotificacoes, 20000);
    fetchNotificacoes();
</script>
{% endblock %} 