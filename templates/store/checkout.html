{% extends 'base.html' %} {% load static %} {% block content %}

<!-- ==== CONTEÚDO PRINCIPAL CHECKOUT ==== -->
<main class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Checkout Form -->
        <div class="lg:col-span-2">
            <!-- Dados de Entrega -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2
                        class="text-2xl font-rajdhani font-bold text-cinnamon-brown"
                    >
                        <i class="fas fa-shipping-fast mr-3 text-primary"></i>
                        Dados de Entrega
                    </h2>
                    <button
                        class="text-primary hover:text-orange-600 font-medium"
                    >
                        <i class="fas fa-edit mr-1"></i>Editar
                    </button>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="font-semibold text-gray-800">
                                João Silva Santos
                            </p>
                            <p class="text-gray-600">joao.silva@email.com</p>
                            <p class="text-gray-600">(11) 99999-9999</p>
                        </div>
                        <div>
                            <p class="text-gray-800">
                                Rua das Especiarias, 123
                            </p>
                            <p class="text-gray-600">Apt 45 - Vila Madalena</p>
                            <p class="text-gray-600">
                                São Paulo - SP, 05435-000
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Método de Pagamento -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2
                    class="text-2xl font-rajdhani font-bold text-cinnamon-brown mb-6"
                >
                    <i class="fas fa-credit-card mr-3 text-primary"></i>
                    Método de Pagamento
                </h2>

                <!-- Payment Methods Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- PIX -->
                    <div
                        class="payment-method border-2 border-gray-200 rounded-lg p-4"
                        data-method="pix"
                    >
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-12 h-12 bg-gradient-to-r from-green-500 to-blue-500 rounded-lg flex items-center justify-center"
                            >
                                <i class="fas fa-qrcode text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">PIX</h3>
                                <p class="text-sm text-gray-600">
                                    Aprovação instantânea
                                </p>
                                <div class="ingredient-badge mt-1">
                                    5% de desconto
                                </div>
                            </div>
                            <div class="ml-auto">
                                <div
                                    class="w-6 h-6 border-2 border-gray-300 rounded-full payment-radio"
                                ></div>
                            </div>
                        </div>
                    </div>

                    <!-- Cartão de Crédito -->
                    <div
                        class="payment-method border-2 border-gray-200 rounded-lg p-4"
                        data-method="credit"
                    >
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg flex items-center justify-center"
                            >
                                <i
                                    class="fas fa-credit-card text-white text-xl"
                                ></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">
                                    Cartão de Crédito
                                </h3>
                                <p class="text-sm text-gray-600">
                                    Até 12x sem juros
                                </p>
                                <div class="flex space-x-1 mt-1">
                                    <i class="fab fa-cc-visa text-blue-600"></i>
                                    <i
                                        class="fab fa-cc-mastercard text-red-500"
                                    ></i>
                                    <i class="fab fa-cc-amex text-blue-500"></i>
                                </div>
                            </div>
                            <div class="ml-auto">
                                <div
                                    class="w-6 h-6 border-2 border-gray-300 rounded-full payment-radio"
                                ></div>
                            </div>
                        </div>
                    </div>

                    <!-- Cartão de Débito -->
                    <div
                        class="payment-method border-2 border-gray-200 rounded-lg p-4"
                        data-method="debit"
                    >
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-blue-500 rounded-lg flex items-center justify-center"
                            >
                                <i
                                    class="fas fa-credit-card text-white text-xl"
                                ></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">
                                    Cartão de Débito
                                </h3>
                                <p class="text-sm text-gray-600">
                                    Débito em conta
                                </p>
                                <div class="flex space-x-1 mt-1">
                                    <i class="fab fa-cc-visa text-blue-600"></i>
                                    <i
                                        class="fab fa-cc-mastercard text-red-500"
                                    ></i>
                                </div>
                            </div>
                            <div class="ml-auto">
                                <div
                                    class="w-6 h-6 border-2 border-gray-300 rounded-full payment-radio"
                                ></div>
                            </div>
                        </div>
                    </div>

                    <!-- Boleto -->
                    <div
                        class="payment-method border-2 border-gray-200 rounded-lg p-4"
                        data-method="boleto"
                    >
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-12 h-12 bg-gradient-to-r from-orange-500 to-red-500 rounded-lg flex items-center justify-center"
                            >
                                <i
                                    class="fas fa-barcode text-white text-xl"
                                ></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">
                                    Boleto Bancário
                                </h3>
                                <p class="text-sm text-gray-600">
                                    Vencimento em 3 dias
                                </p>
                                <div class="ingredient-badge mt-1">
                                    3% de desconto
                                </div>
                            </div>
                            <div class="ml-auto">
                                <div
                                    class="w-6 h-6 border-2 border-gray-300 rounded-full payment-radio"
                                ></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Forms -->
                <div id="payment-forms">
                    <!-- PIX Form -->
                    <div id="pix-form" class="payment-form hidden">
                        <div
                            class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg"
                        >
                            <h3 class="font-semibold text-gray-800 mb-4">
                                <i
                                    class="fas fa-qrcode mr-2 text-green-600"
                                ></i>
                                Pagamento via PIX
                            </h3>
                            <div class="text-center">
                                <div
                                    class="w-48 h-48 bg-white border-2 border-gray-200 rounded-lg mx-auto mb-4 flex items-center justify-center"
                                >
                                    <div class="text-center">
                                        <i
                                            class="fas fa-qrcode text-6xl text-gray-400 mb-2"
                                        ></i>
                                        <p class="text-sm text-gray-600">
                                            QR Code será gerado<br />após
                                            confirmação
                                        </p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">
                                    <i
                                        class="fas fa-info-circle text-blue-500 mr-1"
                                    ></i>
                                    Escaneie o QR Code com o app do seu banco
                                </p>
                                <p class="text-xs text-gray-500">
                                    O pagamento é processado instantaneamente
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Credit Card Form -->
                    <div id="credit-form" class="payment-form hidden">
                        <div class="space-y-4">
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="card-number"
                                    class="form-input"
                                    placeholder=" "
                                    maxlength="19"
                                />
                                <label for="card-number" class="form-label"
                                    >Número do Cartão</label
                                >
                            </div>

                            <div class="form-group">
                                <input
                                    type="text"
                                    id="card-name"
                                    class="form-input"
                                    placeholder=" "
                                />
                                <label for="card-name" class="form-label"
                                    >Nome no Cartão</label
                                >
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group">
                                    <input
                                        type="text"
                                        id="card-expiry"
                                        class="form-input"
                                        placeholder=" "
                                        maxlength="5"
                                    />
                                    <label for="card-expiry" class="form-label"
                                        >MM/AA</label
                                    >
                                </div>
                                <div class="form-group">
                                    <input
                                        type="text"
                                        id="card-cvv"
                                        class="form-input"
                                        placeholder=" "
                                        maxlength="4"
                                    />
                                    <label for="card-cvv" class="form-label"
                                        >CVV</label
                                    >
                                </div>
                            </div>

                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3">
                                    Parcelas
                                </h4>
                                <select
                                    class="w-full p-3 border border-gray-200 rounded-lg"
                                >
                                    <option>1x de R$ 156,90 à vista</option>
                                    <option>2x de R$ 78,45 sem juros</option>
                                    <option>3x de R$ 52,30 sem juros</option>
                                    <option>4x de R$ 39,23 sem juros</option>
                                    <option>5x de R$ 31,38 sem juros</option>
                                    <option>6x de R$ 26,15 sem juros</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Debit Card Form -->
                    <div id="debit-form" class="payment-form hidden">
                        <div class="space-y-4">
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="debit-number"
                                    class="form-input"
                                    placeholder=" "
                                    maxlength="19"
                                />
                                <label for="debit-number" class="form-label"
                                    >Número do Cartão</label
                                >
                            </div>

                            <div class="form-group">
                                <input
                                    type="text"
                                    id="debit-name"
                                    class="form-input"
                                    placeholder=" "
                                />
                                <label for="debit-name" class="form-label"
                                    >Nome no Cartão</label
                                >
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group">
                                    <input
                                        type="text"
                                        id="debit-expiry"
                                        class="form-input"
                                        placeholder=" "
                                        maxlength="5"
                                    />
                                    <label for="debit-expiry" class="form-label"
                                        >MM/AA</label
                                    >
                                </div>
                                <div class="form-group">
                                    <input
                                        type="text"
                                        id="debit-cvv"
                                        class="form-input"
                                        placeholder=" "
                                        maxlength="4"
                                    />
                                    <label for="debit-cvv" class="form-label"
                                        >CVV</label
                                    >
                                </div>
                            </div>

                            <div class="bg-indigo-50 p-4 rounded-lg">
                                <p class="text-sm text-gray-700">
                                    <i
                                        class="fas fa-info-circle text-indigo-500 mr-2"
                                    ></i>
                                    O valor será debitado diretamente da sua
                                    conta bancária
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Boleto Form -->
                    <div id="boleto-form" class="payment-form hidden">
                        <div
                            class="bg-gradient-to-r from-orange-50 to-red-50 p-6 rounded-lg"
                        >
                            <h3 class="font-semibold text-gray-800 mb-4">
                                <i
                                    class="fas fa-barcode mr-2 text-orange-600"
                                ></i>
                                Pagamento via Boleto
                            </h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-700"
                                        >Vencimento:</span
                                    >
                                    <span
                                        class="font-semibold"
                                        id="boleto-due-date"
                                    ></span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-700"
                                        >Valor com desconto:</span
                                    >
                                    <span class="font-semibold text-green-600"
                                        >R$ 152,19</span
                                    >
                                </div>
                                <hr class="border-gray-200" />
                                <p class="text-sm text-gray-600">
                                    <i
                                        class="fas fa-exclamation-triangle text-orange-500 mr-1"
                                    ></i>
                                    O boleto será enviado por email após a
                                    confirmação do pedido
                                </p>
                                <p class="text-xs text-gray-500">
                                    Prazo de processamento: até 2 dias úteis
                                    após o pagamento
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
            <div class="order-summary-sticky">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2
                        class="text-2xl font-rajdhani font-bold text-cinnamon-brown mb-6"
                    >
                        <i class="fas fa-shopping-bag mr-3 text-primary"></i>
                        Resumo do Pedido
                    </h2>

                    <!-- Order Items -->
                    <div class="space-y-4 mb-6">
                        <div
                            class="flex items-center space-x-3 pb-3 border-b border-gray-100"
                        >
                            <img
                                src="https://placehold.co/60x60/D84315/FFFFFF?text=Garam"
                                alt="Garam Masala"
                                class="w-12 h-12 rounded-lg"
                            />
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-800">
                                    Garam Masala Premium
                                </h4>
                                <p class="text-sm text-gray-600">Qtd: 2</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">R$ 50,00</p>
                            </div>
                        </div>

                        <div
                            class="flex items-center space-x-3 pb-3 border-b border-gray-100"
                        >
                            <img
                                src="https://placehold.co/60x60/FFC107/333333?text=Curcuma"
                                alt="Cúrcuma"
                                class="w-12 h-12 rounded-lg"
                            />
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-800">
                                    Cúrcuma Pura
                                </h4>
                                <p class="text-sm text-gray-600">Qtd: 1</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">R$ 18,00</p>
                            </div>
                        </div>

                        <div
                            class="flex items-center space-x-3 pb-3 border-b border-gray-100"
                        >
                            <img
                                src="https://placehold.co/60x60/8D6E63/FFFFFF?text=Chai"
                                alt="Chai"
                                class="w-12 h-12 rounded-lg"
                            />
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-800">
                                    Chá Masala Chai
                                </h4>
                                <p class="text-sm text-gray-600">Qtd: 3</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">R$ 96,00</p>
                            </div>
                        </div>
                    </div>

                    <!-- Coupon -->
                    <div class="mb-6">
                        <div class="flex space-x-2">
                            <input
                                type="text"
                                placeholder="Cupom de desconto"
                                class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm"
                            />
                            <button class="btn btn-secondary px-4 py-2 text-sm">
                                Aplicar
                            </button>
                        </div>
                    </div>

                    <!-- Price Breakdown -->
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal:</span>
                            <span class="font-medium">R$ 164,00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Frete:</span>
                            <span class="font-medium text-green-600"
                                >Grátis</span
                            >
                        </div>
                        <div class="flex justify-between discount-row hidden">
                            <span class="text-gray-600"
                                >Desconto PIX (5%):</span
                            >
                            <span class="font-medium text-green-600"
                                >-R$ 8,20</span
                            >
                        </div>
                        <div
                            class="flex justify-between discount-row-boleto hidden"
                        >
                            <span class="text-gray-600"
                                >Desconto Boleto (3%):</span
                            >
                            <span class="font-medium text-green-600"
                                >-R$ 4,92</span
                            >
                        </div>
                        <hr class="border-gray-200" />
                        <div class="flex justify-between text-lg font-bold">
                            <span>Total:</span>
                            <span class="price-highlight" id="total-price"
                                >R$ 164,00</span
                            >
                        </div>
                    </div>

                    <!-- Security Info -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="flex items-center space-x-2 mb-2">
                            <i class="fas fa-shield-alt text-green-600"></i>
                            <span class="font-semibold text-gray-800"
                                >Compra Protegida</span
                            >
                        </div>
                        <p class="text-xs text-gray-600">
                            Seus dados estão protegidos com criptografia SSL de
                            256 bits
                        </p>
                    </div>

                    <!-- Finalize Button -->
                    <button
                        id="finalize-order"
                        class="btn btn-primary w-full text-lg py-4 font-rajdhani"
                        disabled
                    >
                        <i class="fas fa-lock mr-2"></i>
                        Finalizar Compra
                    </button>

                    <p class="text-xs text-gray-500 text-center mt-3">
                        Ao finalizar, você concorda com nossos
                        <a href="#" class="text-primary hover:underline"
                            >Termos de Uso</a
                        >
                    </p>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Loading Overlay -->
<div id="processing-overlay" class="processing-overlay hidden">
    <div class="processing-spinner"></div>
    <p class="text-white text-lg mt-4">Processando seu pedido...</p>
</div>

<style>
    /* Custom styles for checkout steps and form elements */
    .checkout-step {
        position: relative;
        padding-top: 1.5rem; /* Space for the circle above */
    }

    .checkout-step::before {
        content: "";
        position: absolute;
        width: calc(100% - 2rem); /* Adjust width to connect circles */
        height: 2px;
        background-color: theme("colors.gray.200");
        left: calc(50% + 1rem); /* Start from center of previous circle */
        top: calc(1rem + 4px); /* Align with step-circle center */
        transform: translateY(-50%);
        z-index: 0;
    }

    .checkout-step:first-child::before {
        display: none; /* No line before the first step */
    }

    .checkout-step.active::before {
        background-color: theme("colors.secondary");
    }

    .checkout-step.completed::before {
        background-color: theme("colors.primary");
    }

    .step-circle {
        position: relative;
        z-index: 1;
        width: 2rem; /* 32px */
        height: 2rem; /* 32px */
        border-radius: 9999px; /* Full circle */
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: auto;
        margin-right: auto;
        font-weight: bold;
        transition: background-color 0.3s ease-in-out;
    }

    .checkout-step.active .step-circle {
        background-color: theme("colors.secondary");
    }

    .checkout-step.completed .step-circle {
        background-color: theme("colors.primary");
        color: white; /* Ensure checkmark is visible */
    }

    .checkout-step.completed .step-circle::after {
        content: "\f00c"; /* FontAwesome checkmark icon */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        color: white;
        font-size: 0.8rem;
    }

    /* Form Group Styling */
    .form-group {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid theme("colors.gray.300");
        border-radius: 0.5rem;
        background-color: theme("colors.white");
        font-size: 1rem;
        line-height: 1.5;
        color: theme("colors.gray.900");
        transition:
            border-color 0.2s ease-in-out,
            box-shadow 0.2s ease-in-out;
    }

    .form-input:focus {
        outline: none;
        border-color: theme("colors.primary");
        box-shadow: 0 0 0 3px rgba(theme("colors.primary"), 0.2);
    }

    .form-label {
        position: absolute;
        top: 0.75rem;
        left: 1rem;
        font-size: 1rem;
        color: theme("colors.gray.500");
        pointer-events: none;
        transition: all 0.2s ease-in-out;
        background-color: theme(
            "colors.white"
        ); /* Ensure label doesn't get covered by input value */
        padding: 0 0.25rem;
        margin-left: -0.25rem;
    }

    .form-input:focus + .form-label,
    .form-input:not(:placeholder-shown) + .form-label {
        top: -0.5rem;
        font-size: 0.75rem;
        color: theme("colors.primary");
        transform: translateX(0.5rem);
    }

    /* Payment Method Styling */
    .payment-method.selected {
        border-color: theme("colors.primary");
        box-shadow: 0 0 0 2px rgba(theme("colors.primary"), 0.2);
        background-color: theme("colors.yellow.50");
    }

    /* Sticky Order Summary */
    .order-summary-sticky {
        position: sticky;
        top: 2rem; /* Adjust as needed for header/spacing */
    }

    /* Processing Overlay */
    .processing-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .processing-spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid theme("colors.primary");
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const checkoutForm = document.getElementById("checkout-form");
        const finalizeButton = document.getElementById("finalize-order-button");
        console.log("checkoutForm element:", checkoutForm);
        console.log("finalizeButton element:", finalizeButton);
        const paymentMethods = document.querySelectorAll(".payment-method");
        const subtotalDisplay = document.getElementById("subtotal-display");
        const shippingDisplay = document.getElementById("shipping-display");
        const discountDisplay = document.getElementById("discount-display");
        const discountAmountSpan = document.getElementById("discount-amount");
        const finalTotalDisplay = document.getElementById(
            "final-total-display",
        );
        const processingOverlay = document.getElementById("processing-overlay");

        let basePrice = parseFloat("{{ total_with_shipping|floatformat:2 }}");
        let initialShippingCost = parseFloat(
            "{{ shipping_cost|floatformat:2 }}",
        );
        let selectedPaymentMethod = "credit_card"; // Default selected method

        // Initialize selected payment method visually
        paymentMethods.forEach((label) => {
            const radio = label.querySelector('input[type="radio"]');
            if (radio.checked) {
                label.classList.add("selected");
                selectedPaymentMethod = radio.value;
            }
        });

        // Function to update pricing based on selected payment method
        function updatePricing() {
            let currentTotalPrice = basePrice;
            let discount = 0;
            let currentShippingCost = initialShippingCost; // Use initial shipping cost

            // Update shipping display
            if (shippingDisplay) {
                shippingDisplay.textContent = `R$ ${currentShippingCost.toFixed(2).replace(".", ",")}`;
            }
            currentTotalPrice += currentShippingCost;

            if (selectedPaymentMethod === "pix") {
                discount = currentTotalPrice * 0.05; // 5% discount for PIX
            } else if (selectedPaymentMethod === "boleto") {
                discount = currentTotalPrice * 0.03; // 3% discount for Boleto
            }

            currentTotalPrice -= discount;

            if (discount > 0) {
                if (discountAmountSpan) {
                    discountAmountSpan.textContent = `- R$ ${discount.toFixed(2).replace(".", ",")}`;
                }
                if (discountDisplay) {
                    discountDisplay.classList.remove("hidden");
                }
            } else {
                if (discountDisplay) {
                    discountDisplay.classList.add("hidden");
                }
            }

            if (finalTotalDisplay) {
                finalTotalDisplay.textContent = `R$ ${currentTotalPrice.toFixed(2).replace(".", ",")}`;
            }
        }

        // Function to enable/disable finalize button based on form validity
        function enableFinalizeButton() {
            const formInputs = checkoutForm.querySelectorAll(
                ".form-input[required]",
            );
            let allInputsFilled = true;
            formInputs.forEach((input) => {
                if (!input.value.trim()) {
                    allInputsFilled = false;
                }
            });
            if (finalizeButton) {
                finalizeButton.disabled = !allInputsFilled;
            } else {
                console.error(
                    "finalizeButton element not found in enableFinalizeButton.",
                );
            }
        }

        // Event listeners for payment method selection
        paymentMethods.forEach((label) => {
            label.addEventListener("click", function () {
                // Remove 'selected' from all
                paymentMethods.forEach((lm) => lm.classList.remove("selected"));
                // Add 'selected' to clicked one
                this.classList.add("selected");
                // Update the radio button state
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;
                selectedPaymentMethod = radio.value;
                updatePricing();
            });
        });

        // Event listeners for form input changes to enable/disable button
        const formInputs = checkoutForm
            ? checkoutForm.querySelectorAll(".form-input")
            : [];
        console.log("Form inputs for validation:", formInputs);
        formInputs.forEach((input) => {
            input.addEventListener("input", enableFinalizeButton);
        });

        // Initial calls
        updatePricing(); // Calculate initial total
        enableFinalizeButton(); // Check form validity on load

        // --- Início: Lógica do Mercado Pago ---

        // Injeta o SDK do Mercado Pago dinamicamente no <head>
        const mpScript = document.createElement('script');
        mpScript.src = "https://sdk.mercadopago.com/js/v2";
        document.head.appendChild(mpScript);

        // A lógica de pagamento só é configurada após o carregamento completo do SDK
        mpScript.onload = () => {
            // Inicializa o Mercado Pago com a Chave Pública
            const mp = new mercadopago.MercadoPago("{{ MERCADO_PAGO_PUBLIC_KEY }}", {
                locale: 'pt-BR'
            });

            // Função para renderizar o Botão de Pagamento (Wallet Brick)
            const renderWalletBrick = async (preferenceId) => {
                const bricksBuilder = mp.bricks();

                // Cria um container para o botão se ele ainda não existir
                let walletContainer = document.getElementById("wallet_container");
                if (!walletContainer) {
                    walletContainer = document.createElement("div");
                    walletContainer.id = "wallet_container";
                    const finalizeBtn = document.getElementById('finalize-button');
                    if (finalizeBtn) {
                        // Insere o container do botão de pagamento logo após o botão original
                        finalizeBtn.parentNode.insertBefore(walletContainer, finalizeBtn.nextSibling);
                    } else {
                        // Se não encontrar o botão, adiciona ao final do formulário
                        checkoutForm.appendChild(walletContainer);
                    }
                }

                // Esconde o botão de finalizar original para evitar confusão
                const finalizeBtn = document.getElementById('finalize-button');
                if (finalizeBtn) {
                    finalizeBtn.style.display = 'none';
                }

                // Renderiza o botão de pagamento do Mercado Pago
                await bricksBuilder.create("wallet", "wallet_container", {
                    initialization: {
                        preferenceId: preferenceId,
                    },
                    customization: {
                        texts: { valueProp: 'smart_option' }, // Texto customizável
                    },
                });

                // Esconde o overlay de "processando"
                processingOverlay.classList.add("hidden");
            };

            // Adiciona o listener de evento para o envio do formulário de checkout
            checkoutForm.addEventListener("submit", function (event) {
                event.preventDefault(); // Previne o envio padrão do formulário
                processingOverlay.classList.remove("hidden"); // Mostra o overlay de "processando"

                const formData = new FormData(checkoutForm);
                const data = Object.fromEntries(formData.entries());

                // Faz a requisição para o backend para criar a preferência de pagamento
                fetch("{% url 'store:process_payment' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                    },
                    body: JSON.stringify(data),
                })
                .then(response => {
                    // Verifica se a resposta do servidor foi bem sucedida
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Erro desconhecido no servidor.') });
                    }
                    return response.json();
                })
                .then(data => {
                    // Se o backend retornou um ID de preferência, renderiza o botão de pagamento
                    if (data.preference_id) {
                        renderWalletBrick(data.preference_id);
                    } else {
                        // Caso contrário, lança um erro
                        throw new Error(data.error || "Não foi possível obter a preferência de pagamento.");
                    }
                })
                .catch(error => {
                    // Em caso de erro, esconde o overlay e exibe um alerta
                    processingOverlay.classList.add("hidden");
                    console.error("Erro no processo de pagamento:", error);
                    alert("Ocorreu um erro: " + error.message);
                });
            });
        };
        // --- Fim: Lógica do Mercado Pago ---
                    console.log("Success response data:", data);
                    if (data.success) {
                        window.location.href = data.redirect_url; // Redirect to success page
                    } else {
                        console.error("Server error data:", data);
                        alert(
                            "Erro: " +
                                (data.message || "Ocorreu um erro inesperado."),
                        );
                    }
                })
                .catch((error) => {
                    console.error("Fetch error:", error);
                    alert(
                        "Ocorreu um erro de rede. Por favor, tente novamente mais tarde.",
                    );
                })
                .finally(() => {
                    processingOverlay.classList.add("hidden"); // Always hide loading overlay
                    console.log("Processing overlay hidden.");
                });
        });
    });
</script>

{% endblock content %}
