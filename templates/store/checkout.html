{% extends 'base.html' %} {% load static %} {% block content %}

<!-- ==== CONTEÚDO PRINCIPAL CHECKOUT ==== -->
<main class="container mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Breadcrumb -->
    <nav class="mb-6">
        <ol class="flex space-x-2 text-sm">
            <li>
                <a
                    href="{% url 'store:home' %}"
                    class="text-primary hover:underline"
                    >Início</a
                >
            </li>
            <li class="text-gray-500">/</li>
            <li>
                <a
                    href="{% url 'store:cart' %}"
                    class="text-primary hover:underline"
                    >Carrinho</a
                >
            </li>
            <li class="text-gray-500">/</li>
            <li class="text-gray-700">Finalizar Compra</li>
        </ol>
    </nav>

    <!-- Título da Página com Indicador de Progresso -->
    <div class="text-center mb-10">
        <h1 class="text-5xl font-teko text-secondary mb-4">
            <i class="fas fa-credit-card text-primary mr-3"></i>
            Finalizar Compra
        </h1>
        <p class="text-gray-600 mb-6">
            Preencha seus dados para concluir o pedido
        </p>

        <!-- Barra de Progresso -->
        <div
            class="max-w-xl mx-auto flex justify-between items-center relative after:absolute after:w-full after:h-0.5 after:bg-gray-200 after:top-1/2 after:left-0 after:-translate-y-1/2"
        >
            <div
                class="checkout-step completed relative z-10 text-center flex-1"
            >
                <div
                    class="step-circle bg-primary text-white text-xs font-bold flex items-center justify-center mx-auto rounded-full w-8 h-8 mb-2"
                >
                    1
                </div>
                <span class="text-xs font-medium text-primary">Carrinho</span>
            </div>
            <div class="checkout-step active relative z-10 text-center flex-1">
                <div
                    class="step-circle bg-secondary text-white text-xs font-bold flex items-center justify-center mx-auto rounded-full w-8 h-8 mb-2"
                >
                    2
                </div>
                <span class="text-xs font-medium text-secondary"
                    >Pagamento</span
                >
            </div>
            <div class="checkout-step relative z-10 text-center flex-1">
                <div
                    class="step-circle bg-gray-300 text-gray-700 text-xs font-bold flex items-center justify-center mx-auto rounded-full w-8 h-8 mb-2"
                >
                    3
                </div>
                <span class="text-xs font-medium text-gray-500"
                    >Confirmação</span
                >
            </div>
        </div>
    </div>

    <!-- Layout principal do Checkout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Detalhes de Envio e Pagamento -->
        <div class="lg:col-span-2">
            <form
                id="checkout-form"
                method="post"
                action="{% url 'store:checkout' %}"
                class="bg-white p-6 rounded-lg shadow-md mb-8"
            >
                {% csrf_token %}
                <!-- Informações de Entrega -->
                <div class="mb-8">
                    <h2 class="text-3xl font-teko text-secondary mb-6">
                        Informações de Entrega
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label for="first_name" class="form-label"
                                >Nome *</label
                            >
                            <input
                                type="text"
                                id="first_name"
                                name="first_name"
                                class="form-input"
                                placeholder=" "
                                value="{{ request.user.first_name|default_if_none:'' }}"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="last_name" class="form-label"
                                >Sobrenome *</label
                            >
                            <input
                                type="text"
                                id="last_name"
                                name="last_name"
                                class="form-input"
                                placeholder=" "
                                value="{{ request.user.last_name|default_if_none:'' }}"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="email" class="form-label"
                                >E-mail *</label
                            >
                            <input
                                type="email"
                                id="email"
                                name="email"
                                class="form-input"
                                placeholder=" "
                                value="{{ request.user.email|default_if_none:'' }}"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="address" class="form-label"
                                >Endereço *</label
                            >
                            <input
                                type="text"
                                id="address"
                                name="address"
                                class="form-input"
                                placeholder=" "
                                value="{{ customer_profile.endereco|default_if_none:'' }}"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="postal_code" class="form-label"
                                >CEP *</label
                            >
                            <input
                                type="text"
                                id="postal_code"
                                name="postal_code"
                                class="form-input"
                                placeholder=" "
                                value="{{ customer_profile.cep|default_if_none:'' }}"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="city" class="form-label"
                                >Cidade *</label
                            >
                            <input
                                type="text"
                                id="city"
                                name="city"
                                class="form-input"
                                placeholder=" "
                                value="{{ customer_profile.cidade|default_if_none:'' }}"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="state" class="form-label"
                                >Estado *</label
                            >
                            <input
                                type="text"
                                id="state"
                                name="state"
                                class="form-input"
                                placeholder=" "
                                value="{{ customer_profile.estado|default_if_none:'' }}"
                                required
                            />
                        </div>
                    </div>
                </div>

                <!-- Método de Pagamento -->
                <div class="mb-8">
                    <h2 class="text-3xl font-teko text-secondary mb-6">
                        Método de Pagamento
                    </h2>
                    <div class="space-y-4">
                        <label
                            class="payment-method border p-4 rounded-lg flex items-center cursor-pointer transition-all duration-200"
                            data-payment="credit_card"
                        >
                            <input
                                type="radio"
                                name="payment_method"
                                value="credit_card"
                                class="form-radio text-primary mr-3"
                                checked
                            />
                            <i
                                class="fas fa-credit-card text-2xl text-primary mr-3"
                            ></i>
                            <span class="font-semibold text-lg text-gray-800"
                                >Cartão de Crédito</span
                            >
                            <span
                                class="ml-auto text-sm text-gray-500 hidden md:inline-block"
                                >Visa, Mastercard, Elo</span
                            >
                        </label>

                        <label
                            class="payment-method border p-4 rounded-lg flex items-center cursor-pointer transition-all duration-200"
                            data-payment="pix"
                        >
                            <input
                                type="radio"
                                name="payment_method"
                                value="pix"
                                class="form-radio text-primary mr-3"
                            />
                            <i
                                class="fa-brands fa-pix text-2xl text-green-500 mr-3"
                            ></i>
                            <span class="font-semibold text-lg text-gray-800"
                                >PIX
                                <span class="text-green-600 font-bold ml-2">
                                    (5% de desconto!)</span
                                ></span
                            >
                            <span
                                class="ml-auto text-sm text-gray-500 hidden md:inline-block"
                                >Aprovação imediata</span
                            >
                        </label>

                        <label
                            class="payment-method border p-4 rounded-lg flex items-center cursor-pointer transition-all duration-200"
                            data-payment="boleto"
                        >
                            <input
                                type="radio"
                                name="payment_method"
                                value="boleto"
                                class="form-radio text-primary mr-3"
                            />
                            <i
                                class="fas fa-barcode text-2xl text-orange-500 mr-3"
                            ></i>
                            <span class="font-semibold text-lg text-gray-800"
                                >Boleto Bancário
                                <span class="text-green-600 font-bold ml-2">
                                    (3% de desconto!)</span
                                ></span
                            >
                            <span
                                class="ml-auto text-sm text-gray-500 hidden md:inline-block"
                                >Vencimento em 3 dias úteis</span
                            >
                        </label>
                    </div>
                </div>

                <div class="text-center">
                    <button
                        type="submit"
                        id="finalize-order-button"
                        class="btn btn-primary text-xl w-full py-3"
                        disabled
                    >
                        <i class="fas fa-check-circle mr-3"></i>
                        Finalizar Pedido
                    </button>
                    <div
                        class="security-badge mt-4 mx-auto text-gray-600 text-sm flex items-center justify-center p-3 border border-gray-200 rounded-lg max-w-sm"
                    >
                        <i
                            class="fas fa-lock text-green-500 mr-2 text-base"
                        ></i>
                        Seus dados estão 100% seguros.
                    </div>
                </div>
            </form>
        </div>

        <!-- Resumo do Pedido (Sticky) -->
        <div class="lg:col-span-1">
            <div class="order-summary-sticky bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-3xl font-teko text-secondary mb-6">
                    Seu Pedido
                </h2>
                <div class="space-y-4 mb-6">
                    {% for item in cart.items.all %}
                    <div
                        class="flex items-center justify-between pb-3 border-b border-gray-100 last:border-b-0 last:pb-0"
                    >
                        <div class="flex items-center">
                            <img
                                src="{% if item.product.image %}{{ item.product.image.url }}{% else %}{% static 'images/default-product.png' %}{% endif %}"
                                alt="{{ item.product.name }}"
                                class="w-16 h-16 object-cover rounded-md mr-3"
                            />
                            <div>
                                <h3 class="text-gray-900 font-medium text-sm">
                                    {{ item.product.name }}
                                </h3>
                                <p class="text-gray-500 text-xs">
                                    Quantidade: {{ item.quantity }}
                                </p>
                            </div>
                        </div>
                        <span class="text-gray-800 font-semibold text-sm"
                            >R$ {{ item.total_price|floatformat:2 }}</span
                        >
                    </div>
                    {% endfor %}
                </div>

                <div class="border-t border-gray-200 pt-4 mt-4 space-y-3">
                    <div class="text-gray-700 text-lg">
                        <ul>
                            <li
                                class="flex justify-between py-2 border-b border-gray-200"
                            >
                                <span>Subtotal:</span>
                                <span id="subtotal-display"
                                    >R$ {{ cart.total_price|floatformat:2
                                    }}</span
                                >
                            </li>
                            <li
                                class="flex justify-between py-2 border-b border-gray-200"
                            >
                                <span class="text-gray-600">Frete</span>
                                <span id="shipping-display"
                                    >R$ {{ shipping_cost|floatformat:2 }}</span
                                >
                            </li>
                        </ul>
                    </div>

                    <div
                        id="discount-display"
                        class="flex justify-between text-green-600 text-lg hidden"
                    >
                        <span>Desconto:</span>
                        <span id="discount-amount">- R$ 0,00</span>
                    </div>
                    <div
                        class="flex justify-between font-bold text-xl py-2 border-t border-gray-200 mt-4"
                    >
                        <span>Total:</span>
                        <span
                            id="final-total-display"
                            class="text-primary text-2xl font-teko"
                            >R$ {{ total_with_shipping|floatformat:2 }}</span
                        >
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Loading Overlay -->
<div id="processing-overlay" class="processing-overlay hidden">
    <div class="processing-spinner"></div>
    <p class="text-white text-lg mt-4">Processando seu pedido...</p>
</div>

<style>
    /* Custom styles for checkout steps and form elements */
    .checkout-step {
        position: relative;
        padding-top: 1.5rem; /* Space for the circle above */
    }

    .checkout-step::before {
        content: "";
        position: absolute;
        width: calc(100% - 2rem); /* Adjust width to connect circles */
        height: 2px;
        background-color: theme("colors.gray.200");
        left: calc(50% + 1rem); /* Start from center of previous circle */
        top: calc(1rem + 4px); /* Align with step-circle center */
        transform: translateY(-50%);
        z-index: 0;
    }

    .checkout-step:first-child::before {
        display: none; /* No line before the first step */
    }

    .checkout-step.active::before {
        background-color: theme("colors.secondary");
    }

    .checkout-step.completed::before {
        background-color: theme("colors.primary");
    }

    .step-circle {
        position: relative;
        z-index: 1;
        width: 2rem; /* 32px */
        height: 2rem; /* 32px */
        border-radius: 9999px; /* Full circle */
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: auto;
        margin-right: auto;
        font-weight: bold;
        transition: background-color 0.3s ease-in-out;
    }

    .checkout-step.active .step-circle {
        background-color: theme("colors.secondary");
    }

    .checkout-step.completed .step-circle {
        background-color: theme("colors.primary");
        color: white; /* Ensure checkmark is visible */
    }

    .checkout-step.completed .step-circle::after {
        content: "\f00c"; /* FontAwesome checkmark icon */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        color: white;
        font-size: 0.8rem;
    }

    /* Form Group Styling */
    .form-group {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid theme("colors.gray.300");
        border-radius: 0.5rem;
        background-color: theme("colors.white");
        font-size: 1rem;
        line-height: 1.5;
        color: theme("colors.gray.900");
        transition:
            border-color 0.2s ease-in-out,
            box-shadow 0.2s ease-in-out;
    }

    .form-input:focus {
        outline: none;
        border-color: theme("colors.primary");
        box-shadow: 0 0 0 3px rgba(theme("colors.primary"), 0.2);
    }

    .form-label {
        position: absolute;
        top: 0.75rem;
        left: 1rem;
        font-size: 1rem;
        color: theme("colors.gray.500");
        pointer-events: none;
        transition: all 0.2s ease-in-out;
        background-color: theme(
            "colors.white"
        ); /* Ensure label doesn't get covered by input value */
        padding: 0 0.25rem;
        margin-left: -0.25rem;
    }

    .form-input:focus + .form-label,
    .form-input:not(:placeholder-shown) + .form-label {
        top: -0.5rem;
        font-size: 0.75rem;
        color: theme("colors.primary");
        transform: translateX(0.5rem);
    }

    /* Payment Method Styling */
    .payment-method.selected {
        border-color: theme("colors.primary");
        box-shadow: 0 0 0 2px rgba(theme("colors.primary"), 0.2);
        background-color: theme("colors.yellow.50");
    }

    /* Sticky Order Summary */
    .order-summary-sticky {
        position: sticky;
        top: 2rem; /* Adjust as needed for header/spacing */
    }

    /* Processing Overlay */
    .processing-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .processing-spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid theme("colors.primary");
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const checkoutForm = document.getElementById("checkout-form");
        const finalizeButton = document.getElementById("finalize-order-button");
        console.log("checkoutForm element:", checkoutForm);
        console.log("finalizeButton element:", finalizeButton);
        const paymentMethods = document.querySelectorAll(".payment-method");
        const subtotalDisplay = document.getElementById("subtotal-display");
        const shippingDisplay = document.getElementById("shipping-display");
        const discountDisplay = document.getElementById("discount-display");
        const discountAmountSpan = document.getElementById("discount-amount");
        const finalTotalDisplay = document.getElementById(
            "final-total-display",
        );
        const processingOverlay = document.getElementById("processing-overlay");

        let basePrice = parseFloat("{{ total_with_shipping|floatformat:2 }}");
        let initialShippingCost = parseFloat(
            "{{ shipping_cost|floatformat:2 }}",
        );
        let selectedPaymentMethod = "credit_card"; // Default selected method

        // Initialize selected payment method visually
        paymentMethods.forEach((label) => {
            const radio = label.querySelector('input[type="radio"]');
            if (radio.checked) {
                label.classList.add("selected");
                selectedPaymentMethod = radio.value;
            }
        });

        // Function to update pricing based on selected payment method
        function updatePricing() {
            let currentTotalPrice = basePrice;
            let discount = 0;
            let currentShippingCost = initialShippingCost; // Use initial shipping cost

            // Update shipping display
            if (shippingDisplay) {
                shippingDisplay.textContent = `R$ ${currentShippingCost.toFixed(2).replace(".", ",")}`;
            }
            currentTotalPrice += currentShippingCost;

            if (selectedPaymentMethod === "pix") {
                discount = currentTotalPrice * 0.05; // 5% discount for PIX
            } else if (selectedPaymentMethod === "boleto") {
                discount = currentTotalPrice * 0.03; // 3% discount for Boleto
            }

            currentTotalPrice -= discount;

            if (discount > 0) {
                if (discountAmountSpan) {
                    discountAmountSpan.textContent = `- R$ ${discount.toFixed(2).replace(".", ",")}`;
                }
                if (discountDisplay) {
                    discountDisplay.classList.remove("hidden");
                }
            } else {
                if (discountDisplay) {
                    discountDisplay.classList.add("hidden");
                }
            }

            if (finalTotalDisplay) {
                finalTotalDisplay.textContent = `R$ ${currentTotalPrice.toFixed(2).replace(".", ",")}`;
            }
        }

        // Function to enable/disable finalize button based on form validity
        function enableFinalizeButton() {
            const formInputs = checkoutForm.querySelectorAll(
                ".form-input[required]",
            );
            let allInputsFilled = true;
            formInputs.forEach((input) => {
                if (!input.value.trim()) {
                    allInputsFilled = false;
                }
            });
            if (finalizeButton) {
                finalizeButton.disabled = !allInputsFilled;
            } else {
                console.error(
                    "finalizeButton element not found in enableFinalizeButton.",
                );
            }
        }

        // Event listeners for payment method selection
        paymentMethods.forEach((label) => {
            label.addEventListener("click", function () {
                // Remove 'selected' from all
                paymentMethods.forEach((lm) => lm.classList.remove("selected"));
                // Add 'selected' to clicked one
                this.classList.add("selected");
                // Update the radio button state
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;
                selectedPaymentMethod = radio.value;
                updatePricing();
            });
        });

        // Event listeners for form input changes to enable/disable button
        const formInputs = checkoutForm
            ? checkoutForm.querySelectorAll(".form-input")
            : [];
        console.log("Form inputs for validation:", formInputs);
        formInputs.forEach((input) => {
            input.addEventListener("input", enableFinalizeButton);
        });

        // Initial calls
        updatePricing(); // Calculate initial total
        enableFinalizeButton(); // Check form validity on load

        // Handle form submission
        checkoutForm.addEventListener("submit", function (event) {
            event.preventDefault(); // Prevent default form submission

            processingOverlay.classList.remove("hidden"); // Show loading overlay

            const formData = new FormData(checkoutForm);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            // Remove CSRF token from data object if it's already in headers
            delete data["csrfmiddlewaretoken"];

            fetch(checkoutForm.action, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                    "X-Requested-With": "XMLHttpRequest",
                },
                body: JSON.stringify(data),
            })
                .then((response) => {
                    // processingOverlay.classList.add("hidden"); // Hide loading overlay - moved to finally
                    if (!response.ok) {
                        console.error("HTTP error! Status:", response.status);
                        return response.json().then((errorData) => {
                            console.error("Submission error data:", errorData);
                            alert(
                                "Erro ao finalizar o pedido. Por favor, verifique os dados e tente novamente.",
                            );
                            // Optionally display specific errors from errorData
                            throw new Error("Form submission failed");
                        });
                    }
                    console.log("Response OK, parsing JSON...");
                    return response.json();
                })
                .then((data) => {
                    console.log("Success response data:", data);
                    if (data.success) {
                        window.location.href = data.redirect_url; // Redirect to success page
                    } else {
                        console.error("Server error data:", data);
                        alert(
                            "Erro: " +
                                (data.message || "Ocorreu um erro inesperado."),
                        );
                    }
                })
                .catch((error) => {
                    console.error("Fetch error:", error);
                    alert(
                        "Ocorreu um erro de rede. Por favor, tente novamente mais tarde.",
                    );
                })
                .finally(() => {
                    processingOverlay.classList.add("hidden"); // Always hide loading overlay
                    console.log("Processing overlay hidden.");
                });
        });
    });
</script>

{% endblock content %}
