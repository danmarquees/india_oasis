{% extends 'base.html' %} {% load static %} {% block content %}

<title>
    {% block title %}Cadastro - India Oasis - Temperos e Sabores da Índia
    {%endblock %}
</title>
<style>
    /* Estilos específicos para o formulário de cadastro */
    .form-step {
        display: none;
    }

    .form-step.active {
        display: block;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .step-indicator {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: all 0.3s ease;
        border: 2px solid #e5e7eb;
        position: relative;
    }

    .step-indicator.active {
        background-color: #ff6b35;
        color: white;
        border-color: #ff6b35;
        box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.2);
    }

    .step-indicator.completed {
        background-color: #10b981;
        color: white;
        border-color: #10b981;
    }

    .step-indicator:not(.active):not(.completed) {
        background-color: #f9fafb;
        color: #6b7280;
    }

    .step-line {
        height: 2px;
        background-color: #e5e7eb;
        transition: all 0.3s ease;
        position: relative;
    }

    .step-line.completed {
        background-color: #10b981;
    }

    .form-field-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }

    .password-strength-bar {
        height: 4px;
        border-radius: 2px;
        transition: all 0.3s ease;
        background-color: #e5e7eb;
        margin-top: 8px;
    }

    .password-strength-weak {
        background-color: #ef4444;
        width: 33%;
    }

    .password-strength-medium {
        background-color: #f59e0b;
        width: 66%;
    }

    .password-strength-strong {
        background-color: #10b981;
        width: 100%;
    }

    .loading-spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #ff6b35;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .success-message {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
    }

    .error-message {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
    }

    .error-message.show {
        display: block;
    }
</style>

<!-- ==== CONTEÚDO PRINCIPAL ==== -->
<main class="container mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Breadcrumb -->
    <nav class="mb-6">
        <ol class="flex space-x-2 text-sm">
            <li>
                <a href="index.html" class="text-primary hover:underline"
                    >Início</a
                >
            </li>
            <li class="text-gray-500">/</li>
            <li class="text-gray-700">Cadastro</li>
        </ol>
    </nav>

    <!-- Título da Página -->
    <div class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-teko text-secondary mb-4">
            <i class="fas fa-user-plus text-primary mr-3"></i>
            Criar Sua Conta
        </h1>
        <p class="text-gray-600 text-lg max-w-2xl mx-auto">
            Junte-se à família India Oasis e descubra os autênticos sabores da
            Índia. Crie sua conta para uma experiência personalizada de compras.
        </p>
    </div>

    <!-- Indicador de Progresso -->
    <div class="max-w-4xl mx-auto mb-8">
        <div class="flex items-center justify-center">
            <div class="flex items-center space-x-2">
                <div class="step-indicator active" data-step="1">1</div>
                <span class="text-sm font-medium hidden sm:block"
                    >Dados Pessoais</span
                >
            </div>
            <div class="step-line w-16 mx-4"></div>
            <div class="flex items-center space-x-2">
                <div class="step-indicator" data-step="2">2</div>
                <span class="text-sm font-medium hidden sm:block"
                    >Endereço</span
                >
            </div>
            <div class="step-line w-16 mx-4"></div>
            <div class="flex items-center space-x-2">
                <div class="step-indicator" data-step="3">3</div>
                <span class="text-sm font-medium hidden sm:block"
                    >Confirmação</span
                >
            </div>
        </div>
    </div>

    <!-- Formulário de Cadastro -->
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6 md:p-8">
        <form
            method="pos"
            action="{% url 'store:signup' %}"
            id="cadastro-form"
            class="space-y-6"
        >
            {% csrf_token %}
            <!-- ETAPA 1: Dados Pessoais -->
            <div class="form-step active" id="step-1">
                <h2
                    class="text-2xl font-teko text-secondary mb-6 flex items-center"
                >
                    <i class="fas fa-user text-primary mr-3"></i>
                    Dados Pessoais
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label
                            for="nome"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Nome Completo *
                        </label>
                        <input
                            type="text"
                            id="nome"
                            name="nome"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            placeholder="Seu nome completo"
                        />
                        <div class="error-message" id="error-nome"></div>
                    </div>

                    <div>
                        <label
                            for="cpf"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            CPF *
                        </label>
                        <input
                            type="text"
                            id="cpf"
                            name="cpf"
                            required
                            maxlength="14"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            placeholder="000.000.000-00"
                        />
                        <div class="error-message" id="error-cpf"></div>
                    </div>

                    <div>
                        <label
                            for="email"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            E-mail *
                        </label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            placeholder="seu@email.com"
                        />
                        <div class="error-message" id="error-email"></div>
                    </div>

                    <div>
                        <label
                            for="telefone"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Telefone *
                        </label>
                        <input
                            type="tel"
                            id="telefone"
                            name="telefone"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            placeholder="(11) 99999-9999"
                        />
                        <div class="error-message" id="error-telefone"></div>
                    </div>

                    <div>
                        <label
                            for="data-nascimento"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Data de Nascimento *
                        </label>
                        <input
                            type="date"
                            id="data-nascimento"
                            name="data_nascimento"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        />
                        <div
                            class="error-message"
                            id="error-data-nascimento"
                        ></div>
                    </div>

                    <div>
                        <label
                            for="genero"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Gênero
                        </label>
                        <select
                            id="genero"
                            name="genero"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        >
                            <option value="">Selecione...</option>
                            <option value="masculino">Masculino</option>
                            <option value="feminino">Feminino</option>
                            <option value="nao-informar">
                                Prefiro não informar
                            </option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label
                            for="senha"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Senha *
                        </label>
                        <div class="relative">
                            <input
                                type="password"
                                id="senha"
                                name="password"
                                required
                                minlength="8"
                                class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="Mínimo 8 caracteres"
                            />
                            <button
                                type="button"
                                id="toggle-senha"
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                            >
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength-bar"></div>
                        <span
                            id="password-strength-text"
                            class="text-xs text-gray-500 mt-1 block"
                            >Digite uma senha segura</span
                        >
                        <div class="error-message" id="error-senha"></div>
                    </div>

                    <div>
                        <label
                            for="confirmar-senha"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Confirmar Senha *
                        </label>
                        <div class="relative">
                            <input
                                type="password"
                                id="confirmar-senha"
                                name="password2"
                                required
                                class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="Confirme sua senha"
                            />
                            <button
                                type="button"
                                id="toggle-confirmar-senha"
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                            >
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div
                            class="error-message"
                            id="error-confirmar-senha"
                        ></div>
                    </div>
                </div>

                <div class="flex justify-end mt-8">
                    <button
                        type="button"
                        id="next-step-1"
                        class="btn btn-primary px-8 py-3 text-lg"
                    >
                        Próximo
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- ETAPA 2: Endereço -->
            <div class="form-step" id="step-2">
                <h2
                    class="text-2xl font-teko text-secondary mb-6 flex items-center"
                >
                    <i class="fas fa-map-marker-alt text-primary mr-3"></i>
                    Endereço de Entrega
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <label
                            for="cep"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            CEP *
                        </label>
                        <div class="flex space-x-2">
                            <input
                                type="text"
                                id="cep"
                                name="cep"
                                required
                                maxlength="9"
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                                placeholder="00000-000"
                            />
                            <button
                                type="button"
                                id="buscar-cep"
                                class="btn btn-secondary px-4 py-3 flex items-center"
                            >
                                <i
                                    class="fas fa-search"
                                    id="buscar-cep-icon"
                                ></i>
                                <div
                                    class="loading-spinner hidden"
                                    id="buscar-cep-loading"
                                ></div>
                            </button>
                        </div>
                        <div class="error-message" id="error-cep"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label
                            for="endereco"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Endereço *
                        </label>
                        <input
                            type="text"
                            id="endereco"
                            name="endereco"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            placeholder="Rua, Avenida..."
                        />
                        <div class="error-message" id="error-endereco"></div>
                    </div>

                    <div>
                        <label
                            for="numero"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Número *
                        </label>
                        <input
                            type="text"
                            id="numero"
                            name="numero"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            placeholder="123"
                        />
                        <div class="error-message" id="error-numero"></div>
                    </div>

                    <div>
                        <label
                            for="complemento"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Complemento
                        </label>
                        <input
                            type="text"
                            id="complemento"
                            name="complemento"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            placeholder="Apartamento, bloco..."
                        />
                    </div>

                    <div>
                        <label
                            for="bairro"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Bairro *
                        </label>
                        <input
                            type="text"
                            id="bairro"
                            name="bairro"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            placeholder="Seu bairro"
                        />
                        <div class="error-message" id="error-bairro"></div>
                    </div>

                    <div>
                        <label
                            for="cidade"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Cidade *
                        </label>
                        <input
                            type="text"
                            id="cidade"
                            name="cidade"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                            placeholder="Sua cidade"
                        />
                        <div class="error-message" id="error-cidade"></div>
                    </div>

                    <div>
                        <label
                            for="estado"
                            class="block text-sm font-medium text-gray-700 mb-2"
                        >
                            Estado *
                        </label>
                        <select
                            id="estado"
                            name="estado"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                        >
                            <option value="">Selecione...</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amapá</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Ceará</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Espírito Santo</option>
                            <option value="GO">Goiás</option>
                            <option value="MA">Maranhão</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Pará</option>
                            <option value="PB">Paraíba</option>
                            <option value="PR">Paraná</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piauí</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rondônia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">São Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                        <div class="error-message" id="error-estado"></div>
                    </div>
                </div>

                <div class="flex justify-between mt-8">
                    <button
                        type="button"
                        id="prev-step-2"
                        class="btn btn-secondary px-8 py-3 text-lg"
                    >
                        <i class="fas fa-arrow-left mr-2"></i>
                        Anterior
                    </button>
                    <button
                        type="button"
                        id="next-step-2"
                        class="btn btn-primary px-8 py-3 text-lg"
                    >
                        Próximo
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- ETAPA 3: Confirmação -->
            <div class="form-step" id="step-3">
                <h2
                    class="text-2xl font-teko text-secondary mb-6 flex items-center"
                >
                    <i class="fas fa-check-circle text-primary mr-3"></i>
                    Confirmação de Dados
                </h2>

                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-3">
                                <i class="fas fa-user text-primary mr-2"></i>
                                Dados Pessoais
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div>
                                    <span class="font-medium">Nome:</span>
                                    <span
                                        id="confirm-nome"
                                        class="text-gray-700"
                                    ></span>
                                </div>
                                <div>
                                    <span class="font-medium">CPF:</span>
                                    <span
                                        id="confirm-cpf"
                                        class="text-gray-700"
                                    ></span>
                                </div>
                                <div>
                                    <span class="font-medium">E-mail:</span>
                                    <span
                                        id="confirm-email"
                                        class="text-gray-700"
                                    ></span>
                                </div>
                                <div>
                                    <span class="font-medium">Telefone:</span>
                                    <span
                                        id="confirm-telefone"
                                        class="text-gray-700"
                                    ></span>
                                </div>
                                <div>
                                    <span class="font-medium"
                                        >Data de Nasc.:</span
                                    >
                                    <span
                                        id="confirm-data-nascimento"
                                        class="text-gray-700"
                                    ></span>
                                </div>
                                <div>
                                    <span class="font-medium">Gênero:</span>
                                    <span
                                        id="confirm-genero"
                                        class="text-gray-700"
                                    ></span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-3">
                                <i
                                    class="fas fa-map-marker-alt text-primary mr-2"
                                ></i>
                                Endereço
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div>
                                    <span class="font-medium">CEP:</span>
                                    <span
                                        id="confirm-cep"
                                        class="text-gray-700"
                                    ></span>
                                </div>
                                <div>
                                    <span class="font-medium">Endereço:</span>
                                    <span
                                        id="confirm-endereco-completo"
                                        class="text-gray-700"
                                    ></span>
                                </div>
                                <div>
                                    <span class="font-medium">Bairro:</span>
                                    <span
                                        id="confirm-bairro"
                                        class="text-gray-700"
                                    ></span>
                                </div>
                                <div>
                                    <span class="font-medium">Cidade/UF:</span>
                                    <span
                                        id="confirm-cidade-estado"
                                        class="text-gray-700"
                                    ></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Termos e Condições -->
                <div class="mb-6">
                    <div class="flex items-start space-x-3">
                        <input
                            type="checkbox"
                            id="aceitar-termos"
                            name="aceitarTermos"
                            required
                            class="mt-1 w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary focus:ring-2"
                        />
                        <label
                            for="aceitar-termos"
                            class="text-sm text-gray-700"
                        >
                            Eu li e aceito os
                            <a href="#" class="text-primary hover:underline"
                                >Termos de Uso</a
                            >
                            e a
                            <a href="#" class="text-primary hover:underline"
                                >Política de Privacidade</a
                            >
                            da India Oasis.
                        </label>
                    </div>
                    <div class="error-message" id="error-termos"></div>
                </div>

                <!-- Newsletter -->
                <div class="mb-6">
                    <div class="flex items-start space-x-3">
                        <input
                            type="checkbox"
                            id="aceitar-newsletter"
                            name="aceitarNewsletter"
                            class="mt-1 w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary focus:ring-2"
                        />
                        <label
                            for="aceitar-newsletter"
                            class="text-sm text-gray-700"
                        >
                            Desejo receber ofertas especiais e novidades da
                            India Oasis por e-mail.
                        </label>
                    </div>
                </div>

                <!-- Botões de Navegação -->
                <div class="flex justify-between mt-8">
                    <button
                        type="button"
                        id="prev-step-3"
                        class="btn btn-secondary px-8 py-3 text-lg"
                    >
                        <i class="fas fa-arrow-left mr-2"></i>
                        Anterior
                    </button>
                    <button
                        type="submit"
                        id="finalizar-cadastro"
                        class="btn btn-primary px-8 py-3 text-lg flex items-center"
                    >
                        <span id="submit-text">Finalizar Cadastro</span>
                        <i class="fas fa-user-check ml-2" id="submit-icon"></i>
                        <div
                            class="loading-spinner hidden ml-2"
                            id="submit-loading"
                        ></div>
                    </button>
                </div>
            </div>

            <!-- Mensagem de Sucesso -->
            <div class="success-message" id="success-message">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-2xl mr-3"></i>
                    <div>
                        <h3 class="font-semibold">
                            Cadastro realizado com sucesso!
                        </h3>
                        <p class="text-sm opacity-90">
                            Bem-vindo à família India Oasis. Você receberá um
                            e-mail de confirmação em breve.
                        </p>
                    </div>
                </div>
            </div>
        </form>
    </div>
</main>

<!-- ==== JAVASCRIPT ==== -->
<!-- Cole este script no final do seu arquivo signup.html -->
<script>
    // Variáveis globais
    let currentStep = 1;
    const totalSteps = 3;

    // Inicialização
    document.addEventListener("DOMContentLoaded", function () {
        initializeForm();
        setupEventListeners();
        applyMasks();
    });

    // Configuração inicial do formulário
    function initializeForm() {
        showStep(1);
        updateProgressIndicator();
    }

    // Event Listeners
    function setupEventListeners() {
        // Navegação entre steps
        document
            .getElementById("next-step-1")
            .addEventListener("click", () => nextStep(1));
        document
            .getElementById("next-step-2")
            .addEventListener("click", () => nextStep(2));
        document
            .getElementById("prev-step-2")
            .addEventListener("click", () => prevStep(2));
        document
            .getElementById("prev-step-3")
            .addEventListener("click", () => prevStep(3));

        // Toggle de senha
        document
            .getElementById("toggle-senha")
            .addEventListener("click", () => togglePassword("senha"));
        document
            .getElementById("toggle-confirmar-senha")
            .addEventListener("click", () => togglePassword("confirmar-senha"));

        // Verificação de força da senha
        document
            .getElementById("senha")
            .addEventListener("input", checkPasswordStrength);
        document
            .getElementById("confirmar-senha")
            .addEventListener("input", checkPasswordMatch);

        // Busca de CEP
        document
            .getElementById("buscar-cep")
            .addEventListener("click", buscarCEP);
        document.getElementById("cep").addEventListener("blur", buscarCEP);

        // Submissão do formulário
        document
            .getElementById("cadastro-form")
            .addEventListener("submit", handleFormSubmit);

        // Menu lateral
        document
            .getElementById("open-menu-btn")
            .addEventListener("click", () => {
                document
                    .getElementById("side-menu")
                    .classList.remove("-translate-x-full");
                document
                    .getElementById("menu-overlay")
                    .classList.remove("hidden");
            });

        document
            .getElementById("close-menu-btn")
            .addEventListener("click", closeMenu);
        document
            .getElementById("menu-overlay")
            .addEventListener("click", closeMenu);
    }

    // Aplicar máscaras de entrada
    function applyMasks() {
        // Máscara CPF
        document.getElementById("cpf").addEventListener("input", function (e) {
            let value = e.target.value.replace(/\D/g, "");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            e.target.value = value;
        });

        // Máscara Telefone
        document
            .getElementById("telefone")
            .addEventListener("input", function (e) {
                let value = e.target.value.replace(/\D/g, "");
                value = value.replace(/(\d{2})(\d)/, "($1) $2");
                value = value.replace(/(\d{5})(\d)/, "$1-$2");
                e.target.value = value;
            });

        // Máscara CEP
        document.getElementById("cep").addEventListener("input", function (e) {
            let value = e.target.value.replace(/\D/g, "");
            value = value.replace(/(\d{5})(\d)/, "$1-$2");
            e.target.value = value;
        });
    }

    // Navegação entre steps
    function nextStep(step) {
        if (validateStep(step)) {
            if (step === 2) {
                populateConfirmation();
            }
            currentStep++;
            showStep(currentStep);
            updateProgressIndicator();
        }
    }

    function prevStep(step) {
        currentStep--;
        showStep(currentStep);
        updateProgressIndicator();
    }

    function showStep(step) {
        document.querySelectorAll(".form-step").forEach((stepEl) => {
            stepEl.classList.remove("active");
        });
        document.getElementById(`step-${step}`).classList.add("active");
    }

    function updateProgressIndicator() {
        document
            .querySelectorAll(".step-indicator")
            .forEach((indicator, index) => {
                const stepNumber = index + 1;
                indicator.classList.remove("active", "completed");

                if (stepNumber < currentStep) {
                    indicator.classList.add("completed");
                    indicator.innerHTML = '<i class="fas fa-check"></i>';
                } else if (stepNumber === currentStep) {
                    indicator.classList.add("active");
                    indicator.innerHTML = stepNumber;
                } else {
                    indicator.innerHTML = stepNumber;
                }
            });

        document.querySelectorAll(".step-line").forEach((line, index) => {
            if (index + 1 < currentStep) {
                line.classList.add("completed");
            } else {
                line.classList.remove("completed");
            }
        });
    }

    // Validação de steps
    function validateStep(step) {
        let isValid = true;
        clearErrors();

        if (step === 1) {
            isValid = validatePersonalData();
        } else if (step === 2) {
            isValid = validateAddress();
        }

        return isValid;
    }

    function validatePersonalData() {
        let isValid = true;
        const nome = document.getElementById("nome").value.trim();
        const cpf = document.getElementById("cpf").value.trim();
        const email = document.getElementById("email").value.trim();
        const telefone = document.getElementById("telefone").value.trim();
        const dataNascimento = document.getElementById("data-nascimento").value;
        const senha = document.getElementById("senha").value;
        const confirmarSenha = document.getElementById("confirmar-senha").value;

        if (!nome) {
            showError("error-nome", "Nome é obrigatório");
            isValid = false;
        }

        if (!cpf || !isValidCPF(cpf)) {
            showError("error-cpf", "CPF inválido");
            isValid = false;
        }

        if (!email || !isValidEmail(email)) {
            showError("error-email", "E-mail inválido");
            isValid = false;
        }

        if (!telefone) {
            showError("error-telefone", "Telefone é obrigatório");
            isValid = false;
        }

        if (!dataNascimento) {
            showError(
                "error-data-nascimento",
                "Data de nascimento é obrigatória",
            );
            isValid = false;
        }

        if (!senha || senha.length < 8) {
            showError("error-senha", "Senha deve ter no mínimo 8 caracteres");
            isValid = false;
        }

        if (senha !== confirmarSenha) {
            showError("error-confirmar-senha", "Senhas não coincidem");
            isValid = false;
        }

        return isValid;
    }

    function validateAddress() {
        let isValid = true;
        const cep = document.getElementById("cep").value.trim();
        const endereco = document.getElementById("endereco").value.trim();
        const numero = document.getElementById("numero").value.trim();
        const bairro = document.getElementById("bairro").value.trim();
        const cidade = document.getElementById("cidade").value.trim();
        const estado = document.getElementById("estado").value;

        if (!cep) {
            showError("error-cep", "CEP é obrigatório");
            isValid = false;
        }
        if (!endereco) {
            showError("error-endereco", "Endereço é obrigatório");
            isValid = false;
        }
        if (!numero) {
            showError("error-numero", "Número é obrigatório");
            isValid = false;
        }
        if (!bairro) {
            showError("error-bairro", "Bairro é obrigatório");
            isValid = false;
        }
        if (!cidade) {
            showError("error-cidade", "Cidade é obrigatória");
            isValid = false;
        }
        if (!estado) {
            showError("error-estado", "Estado é obrigatório");
            isValid = false;
        }

        return isValid;
    }

    function isValidCPF(cpf) {
        cpf = cpf.replace(/\D/g, "");
        if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
        let sum = 0;
        for (let i = 0; i < 9; i++) sum += parseInt(cpf.charAt(i)) * (10 - i);
        let remainder = (sum * 10) % 11;
        if (remainder === 10 || remainder === 11) remainder = 0;
        if (remainder !== parseInt(cpf.charAt(9))) return false;
        sum = 0;
        for (let i = 0; i < 10; i++) sum += parseInt(cpf.charAt(i)) * (11 - i);
        remainder = (sum * 10) % 11;
        if (remainder === 10 || remainder === 11) remainder = 0;
        return remainder === parseInt(cpf.charAt(10));
    }

    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function showError(elementId, message) {
        const errorElement = document.getElementById(elementId);
        if (!errorElement) return;
        const inputElement =
            errorElement.previousElementSibling ||
            errorElement.parentElement.querySelector("input, select");
        errorElement.textContent = message;
        errorElement.classList.add("show");
        if (inputElement) inputElement.classList.add("form-field-error");
    }

    function clearErrors() {
        document.querySelectorAll(".error-message").forEach((error) => {
            error.classList.remove("show");
            error.textContent = "";
        });
        document.querySelectorAll(".form-field-error").forEach((field) => {
            field.classList.remove("form-field-error");
        });
    }

    function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const button = document.getElementById(`toggle-${fieldId}`);
        const icon = button.querySelector("i");
        if (field.type === "password") {
            field.type = "text";
            icon.classList.replace("fa-eye", "fa-eye-slash");
        } else {
            field.type = "password";
            icon.classList.replace("fa-eye-slash", "fa-eye");
        }
    }

    function checkPasswordStrength() {
        const password = document.getElementById("senha").value;
        const strengthBar = document.querySelector(".password-strength-bar");
        const strengthText = document.getElementById("password-strength-text");
        let strength = 0;
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[^a-zA-Z\d]/.test(password)) strength++;
        strengthBar.className = "password-strength-bar";
        if (strength <= 2) {
            strengthBar.classList.add("password-strength-weak");
            strengthText.textContent = "Senha fraca";
            strengthText.className = "text-xs text-red-500 mt-1 block";
        } else if (strength <= 3) {
            strengthBar.classList.add("password-strength-medium");
            strengthText.textContent = "Senha média";
            strengthText.className = "text-xs text-yellow-500 mt-1 block";
        } else {
            strengthBar.classList.add("password-strength-strong");
            strengthText.textContent = "Senha forte";
            strengthText.className = "text-xs text-green-500 mt-1 block";
        }
    }

    function checkPasswordMatch() {
        const password = document.getElementById("senha").value;
        const confirmPassword =
            document.getElementById("confirmar-senha").value;
        const errorElement = document.getElementById("error-confirmar-senha");
        if (confirmPassword && password !== confirmPassword) {
            showError("error-confirmar-senha", "Senhas não coincidem");
        } else {
            errorElement.classList.remove("show");
            document
                .getElementById("confirmar-senha")
                .classList.remove("form-field-error");
        }
    }

    async function buscarCEP() {
        const cepInput = document.getElementById("cep");
        const cep = cepInput.value.replace(/\D/g, "");
        if (cep.length !== 8) return;
        const loadingElement = document.getElementById("buscar-cep-loading");
        const iconElement = document.getElementById("buscar-cep-icon");
        loadingElement.classList.remove("hidden");
        iconElement.classList.add("hidden");
        try {
            const response = await fetch(
                `https://viacep.com.br/ws/${cep}/json/`,
            );
            const data = await response.json();
            if (!data.erro) {
                document.getElementById("endereco").value =
                    data.logradouro || "";
                document.getElementById("bairro").value = data.bairro || "";
                document.getElementById("cidade").value = data.localidade || "";
                document.getElementById("estado").value = data.uf || "";
            } else {
                showError("error-cep", "CEP não encontrado");
            }
        } catch (error) {
            showError("error-cep", "Erro ao buscar CEP");
        } finally {
            loadingElement.classList.add("hidden");
            iconElement.classList.remove("hidden");
        }
    }

    function populateConfirmation() {
        const generoMap = {
            masculino: "Masculino",
            feminino: "Feminino",
            "nao-informar": "Prefiro não informar",
        };
        document.getElementById("confirm-nome").textContent =
            document.getElementById("nome").value;
        document.getElementById("confirm-cpf").textContent =
            document.getElementById("cpf").value;
        document.getElementById("confirm-email").textContent =
            document.getElementById("email").value;
        document.getElementById("confirm-telefone").textContent =
            document.getElementById("telefone").value;
        document.getElementById("confirm-data-nascimento").textContent =
            new Date(
                document.getElementById("data-nascimento").value,
            ).toLocaleDateString("pt-BR");
        document.getElementById("confirm-genero").textContent =
            generoMap[document.getElementById("genero").value] ||
            "Não informado";
        document.getElementById("confirm-cep").textContent =
            document.getElementById("cep").value;
        document.getElementById("confirm-bairro").textContent =
            document.getElementById("bairro").value;
        const endereco = document.getElementById("endereco").value;
        const numero = document.getElementById("numero").value;
        const complemento = document.getElementById("complemento").value;
        let enderecoCompleto = `${endereco}, ${numero}`;
        if (complemento) enderecoCompleto += ` - ${complemento}`;
        document.getElementById("confirm-endereco-completo").textContent =
            enderecoCompleto;
        const cidade = document.getElementById("cidade").value;
        const estado = document.getElementById("estado").value;
        document.getElementById("confirm-cidade-estado").textContent =
            `${cidade}/${estado}`;
    }

    // ===================================================================
    // FUNÇÃO DE SUBMISSÃO DO FORMULÁRIO CORRIGIDA
    // ===================================================================
    async function handleFormSubmit(e) {
        e.preventDefault(); // Impede a submissão padrão do formulário
        clearErrors(); // Limpa quaisquer mensagens de erro anteriores

        // Validação final do lado do cliente
        if (!document.getElementById("aceitar-termos").checked) {
            showError(
                "error-termos",
                "Você deve aceitar os termos de uso para continuar.",
            );
            return;
        }

        const form = e.target;
        const formData = new FormData(form);

        const submitButton = document.getElementById("finalizar-cadastro");
        const submitText = document.getElementById("submit-text");
        const submitIcon = document.getElementById("submit-icon");
        const submitLoading = document.getElementById("submit-loading");

        // Ativa o estado de "carregando" no botão
        submitButton.disabled = true;
        submitText.textContent = "Processando...";
        submitIcon.classList.add("hidden");
        submitLoading.classList.remove("hidden");

        try {
            // Envia os dados do formulário para a view do Django usando fetch
            const response = await fetch(form.action, {
                method: "POST",
                body: formData,
                headers: {
                    // Este header ajuda o Django a identificar a requisição como AJAX
                    "X-Requested-With": "XMLHttpRequest",
                },
            });

            // Converte a resposta do servidor para JSON
            const data = await response.json();

            if (data.success) {
                // Se o backend retornar sucesso, mostra a mensagem de sucesso
                document.getElementById("success-message").style.display =
                    "block";
                document.getElementById("cadastro-form").style.display = "none";

                // Redireciona para a página inicial após 3 segundos
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 3000);
            } else {
                // Se o backend retornar erros, exibe-os
                if (data.errors) {
                    Object.keys(data.errors).forEach((fieldName) => {
                        const messages = data.errors[fieldName];
                        // Mapeia o nome do campo do backend para o ID do elemento de erro no HTML
                        const errorElementId = `error-${fieldName.replace("password2", "confirmar-senha").replace("password", "senha")}`;
                        showError(errorElementId, messages.join(" "));
                    });
                    // Se o erro for de dados pessoais, volta para a primeira etapa
                    if (
                        data.errors.email ||
                        data.errors.password ||
                        data.errors.nome ||
                        data.errors.cpf
                    ) {
                        currentStep = 1;
                        showStep(1);
                        updateProgressIndicator();
                    }
                }
                alert("Por favor, corrija os erros indicados no formulário.");
            }
        } catch (error) {
            // Em caso de erro de rede ou outro problema
            console.error("Erro na submissão do formulário:", error);
            alert(
                "Ocorreu um erro de comunicação com o servidor. Tente novamente.",
            );
        } finally {
            // Restaura o botão para o estado normal, independentemente do resultado
            submitButton.disabled = false;
            submitText.textContent = "Finalizar Cadastro";
            submitIcon.classList.remove("hidden");
            submitLoading.classList.add("hidden");
        }
    }
    // ===================================================================
    // FIM DA FUNÇÃO CORRIGIDA
    // ===================================================================

    function closeMenu() {
        document.getElementById("side-menu").classList.add("-translate-x-full");
        document.getElementById("menu-overlay").classList.add("hidden");
    }

    // Esta função é um exemplo, substitua pela sua lógica real de carrinho
    function loadCartCount() {
        // Você precisará de uma view no Django para fornecer esse número via AJAX
        // ou passá-lo no contexto inicial da página.
        // Por enquanto, deixaremos como 0.
        // const cartCount = "{{ cart.total_items|default:0 }}";
        // document.getElementById("cart-count").textContent = cartCount;
    }

    loadCartCount();
</script>
{% endblock content %}
